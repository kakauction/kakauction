<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="config.mybatis.mapper.oracle.auction">

	<sql id="searchWhere">
		<where>
			<if test="searchKeyword!=null and searchKeyword!=''">
				${searchCondition} 
				like '%' || #{searchKeyword} || '%'
			</if>
		</where>
	</sql>
	
	<select id="selectCarList" resultType="AuctionVO">
		select * from car where car_auction_yn='N'
	</select>
	
	<select id="selectAuctionCar" parameterType="String" resultType="AuctionCarVO">
		select * from auction_car where car_num=#{carNum}
	</select>
	
	<insert id="insertAuction" parameterType="AuctionVO">
		<selectKey keyProperty="auctionNo" resultType="int" order="BEFORE">
			select auction_seq.nextval from dual
		</selectKey>
		insert into auction(AUCTION_NO_YEAR,AUCTION_NO_CAR,AUCTION_NO,
		CAR_NUM,SELLER_MEMBER_ID,AUCTION_PROMP,AUCTION_FIRSTPRICE,AUCTION_STATE)
		values(to_char(sysdate, 'yyyy'),#{auctionNoCar},#{auctionNo},
		#{carNum},#{sellerMemberId},#{auctionPromp},#{auctionFirstprice},'START')
	</insert>
	
	<update id="updateAuctionYn" parameterType="AuctionVO">
		update car set car_auction_yn='Y' where car_num=#{carNum} and member_id=#{sellerMemberId}
	</update>
	
	<select id="selectAll" resultType="AuctionCarVO" parameterType="SearchVO">
		select *
		from
		(
		    select rownum as RNUM, LIST_ALL.*
		    from
		        (select * from Auction_Car2
		        <include refid="searchWhere"></include>
		        ) LIST_ALL    
		) 
		<![CDATA[
		where  RNUM> #{firstRecordIndex} 
			and RNUM<= #{firstRecordIndex}
			+ #{recordCountPerPage}
		]]>
	</select>
	
	<select id="selectTotalCount" resultType="int" parameterType="SearchVO">
		select count(*) from auction order by auction_no
		<include refid="searchWhere"></include>
	</select>
	
	<select id="updateAuction" parameterType="int">
		update auction
		set AUCTION_READ_COUNT=AUCTION_READ_COUNT+1
		where auction_no = #{auctionNo}
	</select>
	
	<select id="selectByCarNum" parameterType="string" resultType="carVo">
		select * from car
		where car_num=#{carNum}
	</select>
	
	<select id="selectAuction" resultType="AuctionCarVO" parameterType="int">
		select * from auction_car2 where auction_no=#{auctionNo}
	</select>
	
	<update id="auctionDenyCar" parameterType="string">
		update car
		set CAR_AUCTION_YN='D'
		where car_num=#{carNum}
	</update>	
	<update id="auctionDeferCar" parameterType="string">
		update car
		set CAR_AUCTION_YN='B'
		where car_num=#{carNum}
	</update>	
</mapper>