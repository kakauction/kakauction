<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="config.mybatis.mapper.oracle.auction">

	<sql id="searchWhere">
		<where>
			<if test="searchKeyword!=null and searchKeyword!=''">
				${searchCondition} 
				like '%' || #{searchKeyword} || '%'
			</if>
		</where>
	</sql>
	
	<select id="selectCarList" resultType="AuctionVO">
		select * from car where car_auction_yn='N'
	</select>
	
	<select id="selectAuctionCar" parameterType="string" resultType="AuctionCarVO">
		select * from auction_car where car_num=#{carNum}
	</select>
	
	<select id="selectMemberGrade" parameterType="string" resultType="string">
		select member_grade from member where member_id=#{sellerMemberId}
	</select>
	
	<insert id="insertAuction" parameterType="AuctionVO">
		<selectKey keyProperty="auctionNo" resultType="int" order="BEFORE">
			select auction_seq.nextval from dual
		</selectKey>
		insert into auction(AUCTION_NO_YEAR,AUCTION_NO_CAR,AUCTION_NO,
		CAR_NUM,SELLER_MEMBER_ID,AUCTION_PROMP,AUCTION_FIRSTPRICE,AUCTION_STATE,auction_finish)
		values(to_char(sysdate, 'yyyy'),#{auctionNoCar},#{auctionNo},
		#{carNum},#{sellerMemberId},#{auctionPromp},#{auctionFirstprice},'START',sysdate+#{auctionFinishTime})
	</insert>
	
	<update id="updateAuctionYn" parameterType="AuctionVO">
		update car set car_auction_yn='Y' where car_num=#{carNum} and seller_member_id=#{sellerMemberId}
	</update>
	
	<select id="selectAll" resultType="AuctionCarVO" parameterType="SearchVO">
		select *
		from
		(
		    select rownum as RNUM, LIST_ALL.*
		    from
		        (select * from Auction_Car2
		        <include refid="searchWhere"></include>
		        ) LIST_ALL    
		) 
		<![CDATA[
		where  RNUM> #{firstRecordIndex} 
			and RNUM<= #{firstRecordIndex}
			+ #{recordCountPerPage}
		]]>
	</select>
	
	<select id="selectTotalCount" resultType="int" parameterType="SearchVO">
		select count(*) from auction order by auction_no
		<include refid="searchWhere"></include>
	</select>
	
	<select id="updateAuction" parameterType="int">
		update auction
		set AUCTION_READ_COUNT=AUCTION_READ_COUNT+1
		where auction_no = #{auctionNo}
	</select>
	
	<select id="selectByCarNum" parameterType="string" resultType="carVo">
		select * from car
		where car_num=#{carNum}
	</select>
	
	<select id="selectAuction" resultType="AuctionCarVO" parameterType="int">
		select * from auction_car2 where auction_no=#{auctionNo}
	</select>
	
	<update id="auctionDenyCar" parameterType="string">
		update car
		set CAR_AUCTION_YN='D'
		where car_num=#{carNum}
	</update>	
	<update id="auctionDeferCar" parameterType="string">
		update car
		set CAR_AUCTION_YN='B'
		where car_num=#{carNum}
	</update>
	
	<select id="selectAuctionGo" parameterType="int" resultType="map">
		select a.auction_no_year, a.auction_no_car, a.auction_no, a.auction_promp, 
		a.auction_firstprice, a.auction_regdate, a.auction_state, auction_finish,a.auction_read_count,
		c.car_num, c.seller_member_id,c.car_model, c.car_size, c.car_price, c.car_birth, c.car_am, 
		c.car_gas, c.car_dist, p.picture_1, p.picture_2, p.picture_3, p.picture_4, p.picture_5, p.picture_6, p.picture_7
		, p.picture_8, p.picture_9, p.picture_10, p.picture_11, p.picture_12, p.picture_13, p.picture_14, p.picture_15, 
		p.picture_16, p.picture_17, p.picture_18, p.picture_19, p.picture_20 
		from auction a, car c, picture p  
		where a.car_num=c.car_num
		and c.car_num=P.car_num 
		and auction_no=#{auctionNo} and c.car_auction_Yn='Y'
	</select>
	
	<!-- Buyer -->
	<insert id="insertBuyer" parameterType="BuyerVO">
		insert into buyer(buyer_member_id, auction_no)
		values(#{buyerMemberId},#{auctionNo})
	</insert>
	
	<select id="selectBuyerByIdNo" parameterType="BuyerVO" resultType="int">
		select count(*) from buyer where buyer_member_id=#{buyerMemberId} and auction_no=#{auctionNo}	
	</select>
	
	<!--Record-->
	<insert id="insertRecord" parameterType="BuyerVO">
		<selectKey keyProperty="recordNo" resultType="int" order="BEFORE">
			select record_seq.nextval from dual
		</selectKey>
		insert into record
		values(#{recordNo},#{buyerMemberId},#{recordPrice},#{auctionNo}, sysdate, #{carNum}, #{sellerMemberId})
	</insert>
	
	<select id="selectHighPrice" parameterType="int" resultType="HighPriceVO">
		select * from highPrice where auction_no=#{auctionNo} and rownum=1
	</select>

	<select id="selectHighPriceCount" parameterType="int" resultType="int">
		select count(*) from highPrice where auction_no=#{auctionNo}
	</select>
	
</mapper>